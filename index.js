const express = require('express');
const line = require('@line/bot-sdk');
const admin = require('firebase-admin');
const fuzzysort = require('fuzzysort');

const app = express();

// LINE Bot configuration
const config = {
  channelAccessToken: process.env.CHANNEL_ACCESS_TOKEN,
  channelSecret: process.env.CHANNEL_SECRET,
};

const client = new line.Client(config);

// Firebase configuration - ‡πÉ‡∏ä‡πâ variables ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
console.log('Initializing Firebase...');

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö environment variables
const requiredEnvVars = [
  'CHANNEL_ACCESS_TOKEN',
  'CHANNEL_SECRET',
  'FIREBASE_PROJECT_ID',
  'FIREBASE_PRIVATE_KEY',
  'FIREBASE_CLIENT_EMAIL',
  'FIREBASE_CLIENT_ID',
  'FIREBASE_PRIVATE_KEY_ID',
  'FIREBASE_CLIENT_CERT_URL'
];

const missingVars = requiredEnvVars.filter(varName => !process.env[varName]);
if (missingVars.length > 0) {
  console.error('‚ùå Missing required environment variables:', missingVars);
  process.exit(1);
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á service account object
const serviceAccount = {
  type: "service_account",
  project_id: process.env.FIREBASE_PROJECT_ID,
  private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
  // ‡πÅ‡∏õ‡∏•‡∏á \\n ‡πÄ‡∏õ‡πá‡∏ô newline ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏•‡∏ö quotes ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏°‡∏≤
  private_key: process.env.FIREBASE_PRIVATE_KEY
    .replace(/\\n/g, '\n')
    .replace(/^"/, '')
    .replace(/"$/, ''),
  client_email: process.env.FIREBASE_CLIENT_EMAIL,
  client_id: process.env.FIREBASE_CLIENT_ID,
  auth_uri: "https://accounts.google.com/o/oauth2/auth",
  token_uri: "https://oauth2.googleapis.com/token",
  auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
  client_x509_cert_url: process.env.FIREBASE_CLIENT_CERT_URL
};

console.log('‚úÖ Service account configured');
console.log('üìß Client email:', serviceAccount.client_email);
console.log('üîë Project ID:', serviceAccount.project_id);
console.log('üîê Private key length:', serviceAccount.private_key.length);

// Initialize Firebase Admin
try {
  admin.initializeApp({
    credential: admin.credential.cert(serviceAccount),
    databaseURL: `https://${serviceAccount.project_id}-default-rtdb.asia-southeast1.firebasedatabase.app/`
  });
  console.log('‚úÖ Firebase initialized successfully');
} catch (error) {
  console.error('‚ùå Firebase initialization error:', error.message);
  console.error('Full error:', error);
  process.exit(1);
}

const db = admin.firestore();

// Test Firestore connection - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö preferences collection
async function testFirestoreConnection() {
  try {
    console.log('üîç Testing Firestore connection...');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö collection preferences
    const preferencesSnapshot = await db.collection('preferences').get();
    console.log('üìÑ Documents in preferences collection:', preferencesSnapshot.size);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ documents ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const docNames = [];
    preferencesSnapshot.forEach(doc => {
      docNames.push(doc.id);
    });
    console.log('üìã Document names:', docNames);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö audio_content document
    const audioContentDoc = await db.collection('preferences').doc('audio_content').get();
    if (audioContentDoc.exists) {
      console.log('üéµ audio_content document exists');
      const data = audioContentDoc.data();
      console.log('üìù Sample fields:', Object.keys(data));
    }
    
    console.log('‚úÖ Firestore connection successful');
    
  } catch (error) {
    console.error('‚ùå Firestore connection failed:', error.message);
    console.error('Error code:', error.code);
  }
}

// Test connection on startup
testFirestoreConnection();

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
function detectPersonInQuestion(question) {
  const lowerQuestion = question.toLowerCase();
  
  // ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô
  const fernKeywords = ['‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô', 'fern', '‡πÄ‡∏ü‡∏¥', '‡πÄ‡∏ü‡∏¥‡πà‡∏ô'];
  const nannamKeywords = ['‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥', 'nannam', '‡∏ô‡∏≤‡∏ô‡∏≤‡∏°', '‡∏ô‡πà‡∏≤‡∏ô', '‡∏ô‡∏≤‡∏ô'];
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô
  const hasFernKeyword = fernKeywords.some(keyword => 
    lowerQuestion.includes(keyword.toLowerCase())
  );
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥
  const hasNannamKeyword = nannamKeywords.some(keyword => 
    lowerQuestion.includes(keyword.toLowerCase())
  );
  
  if (hasFernKeyword && !hasNannamKeyword) {
    return 'fern';
  } else if (hasNannamKeyword && !hasFernKeyword) {
    return 'nannam';
  } else {
    return 'both'; // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å)
function cleanQuestion(question) {
  const fernKeywords = ['‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô', 'fern', '‡πÄ‡∏ü‡∏¥', '‡πÄ‡∏ü‡∏¥‡πà‡∏ô'];
  const nannamKeywords = ['‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥', 'nannam', '‡∏ô‡∏≤‡∏ô‡∏≤‡∏°', '‡∏ô‡πà‡∏≤‡∏ô', '‡∏ô‡∏≤‡∏ô'];
  
  let cleanedQuestion = question;
  
  // ‡∏•‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
  [...fernKeywords, ...nannamKeywords].forEach(name => {
    const regex = new RegExp(name, 'gi');
    cleanedQuestion = cleanedQuestion.replace(regex, '').trim();
  });
  
  // ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ã‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡∏≠‡∏ö ‡∏ä‡∏≠‡∏ö" -> "‡∏ä‡∏≠‡∏ö"
  cleanedQuestion = cleanedQuestion.replace(/\s+/g, ' ').trim();
  
  return cleanedQuestion;
}

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Fuzzy search function ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô
async function findAnswer(originalQuestion) {
  try {
    console.log('üîç Original question:', originalQuestion);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÉ‡∏Ñ‡∏£
    const targetPerson = detectPersonInQuestion(originalQuestion);
    console.log('üë§ Target person detected:', targetPerson);
    
    // ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
    const cleanedQuestion = cleanQuestion(originalQuestion);
    console.log('üßπ Cleaned question:', cleanedQuestion);
    
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    const searchQuestion = cleanedQuestion || originalQuestion;
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å documents ‡πÉ‡∏ô preferences collection
    const preferencesSnapshot = await db.collection('preferences').get();
    
    if (preferencesSnapshot.empty) {
      console.log('üì≠ No documents found in preferences collection');
      return '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
    }

    console.log('üìÑ Documents in preferences collection:', preferencesSnapshot.size);

    let bestMatch = null;
    let bestScore = -Infinity;
    let bestDocId = '';

    // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ó‡∏∏‡∏Å documents
    preferencesSnapshot.forEach(doc => {
      const data = doc.data();
      const docId = doc.id;
      
      console.log(`üîç Checking document: ${docId}`);
      
      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å question field
      if (data.question) {
        const result = fuzzysort.single(searchQuestion, data.question);
        if (result && result.score > bestScore) {
          bestScore = result.score;
          bestMatch = data;
          bestDocId = docId;
          console.log(`üìà New best match from question in ${docId}: score ${result.score}`);
        }
      }

      // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å keywords array
      if (data.keywords && Array.isArray(data.keywords)) {
        data.keywords.forEach((keyword, index) => {
          const result = fuzzysort.single(searchQuestion, keyword);
          if (result && result.score > bestScore) {
            bestScore = result.score;
            bestMatch = data;
            bestDocId = docId;
            console.log(`üìà New best match from keyword[${index}] "${keyword}" in ${docId}: score ${result.score}`);
          }
        });
      }
    });

    console.log('üéØ Final best match score:', bestScore);
    console.log('üìÑ Best match from document:', bestDocId);

    // ‡πÉ‡∏ä‡πâ threshold ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
    if (bestMatch && bestScore > -3000) {
      // ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡πÉ‡∏Ñ‡∏£
      let selectedAnswer = '';
      
      if (targetPerson === 'fern' && bestMatch.fern_answer) {
        // ‡∏ñ‡∏≤‡∏°‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        selectedAnswer = `‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô: ${bestMatch.fern_answer}`;
      } else if (targetPerson === 'nannam' && bestMatch.nannam_answer) {
        // ‡∏ñ‡∏≤‡∏°‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡πÄ‡∏â‡∏û‡∏≤‡∏∞
        selectedAnswer = `‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥: ${bestMatch.nannam_answer}`;
      } else if (targetPerson === 'both') {
        // ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏∑‡∏≠‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà - ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏∏‡πà‡∏°
        const answers = [];
        if (bestMatch.fern_answer) answers.push(`‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô: ${bestMatch.fern_answer}`);
        if (bestMatch.nannam_answer) answers.push(`‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥: ${bestMatch.nannam_answer}`);
        
        if (answers.length === 2) {
          // ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà - ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà
          selectedAnswer = answers.join('\n\n');
        } else if (answers.length === 1) {
          // ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          selectedAnswer = answers[0];
        }
      }
      
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏∑‡πà‡∏ô
      if (!selectedAnswer) {
        const fallbackAnswers = [];
        if (bestMatch.fern_answer) fallbackAnswers.push(`‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô: ${bestMatch.fern_answer}`);
        if (bestMatch.nannam_answer) fallbackAnswers.push(`‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥: ${bestMatch.nannam_answer}`);
        
        if (fallbackAnswers.length > 0) {
          if (targetPerson === 'fern') {
            selectedAnswer = `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ üòÖ`;
          } else if (targetPerson === 'nannam') {
            selectedAnswer = `‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ üòÖ`;
          } else {
            // ‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
            selectedAnswer = fallbackAnswers[Math.floor(Math.random() * fallbackAnswers.length)];
          }
        }
      }
      
      if (selectedAnswer) {
        console.log('‚úÖ Answer found:', selectedAnswer.substring(0, 100) + '...');
        return selectedAnswer;
      } else {
        console.log('‚ö†Ô∏è Match found but no suitable answers available');
        return `‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö "${bestMatch.question || '‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ'}" ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏±‡∏ö üòÖ`;
      }
    }

    console.log('‚ùå No matching answer found');
    return '‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ô‡∏µ‡πâ üòÖ\n‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö\n\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:\n- "‡πÄ‡∏ü‡∏¥‡∏£‡πå‡∏ô‡∏ä‡∏≠‡∏ö‡∏î‡∏∑‡πà‡∏°‡∏≠‡∏∞‡πÑ‡∏£"\n- "‡∏ô‡πà‡∏≤‡∏ô‡∏ô‡πâ‡∏≥‡∏ä‡∏≠‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£"';

  } catch (error) {
    console.error('‚ùå Error finding answer:', error);
    console.error('Error details:', error.message);
    return '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üôè';
  }
}

// Handle events
async function handleEvent(event) {
  try {
    if (event.type !== 'message' || event.message.type !== 'text') {
      return Promise.resolve(null);
    }

    const userMessage = event.message.text.trim();
    console.log('üí¨ Received message:', userMessage);
    
    // ‡∏´‡∏≤‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Firebase
    const answer = await findAnswer(userMessage);

    console.log('üì§ Sending reply...');
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: answer
    });
  } catch (error) {
    console.error('‚ùå Error handling event:', error);
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á üôè'
    });
  }
}

// Middleware
app.use('/webhook', line.middleware(config));

// Routes
app.get('/', (req, res) => {
  res.send(`
    <h1>LINE Bot is running! üéâ</h1>
    <p>Firebase Status: ‚úÖ Connected</p>
    <p>Project ID: ${process.env.FIREBASE_PROJECT_ID}</p>
    <p>Server Time: ${new Date().toISOString()}</p>
    <p>Features: ‚úÖ Person-specific answers</p>
  `);
});

app.post('/webhook', (req, res) => {
  Promise.all(req.body.events.map(handleEvent))
    .then((result) => {
      console.log('‚úÖ Webhook processed successfully');
      res.json(result);
    })
    .catch((err) => {
      console.error('‚ùå Webhook error:', err);
      res.status(500).end();
    });
});

// Health check endpoint
app.get('/health', (req, res) => {
  res.status(200).json({ 
    status: 'OK', 
    timestamp: new Date().toISOString(),
    firebase: 'connected',
    project_id: process.env.FIREBASE_PROJECT_ID,
    features: ['person_detection', 'fuzzy_search']
  });
});

// ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á Debug endpoint ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö collection ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
app.get('/debug', async (req, res) => {
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö preferences collection
    const preferencesSnapshot = await db.collection('preferences').limit(5).get();
    const preferencesDocs = [];
    preferencesSnapshot.forEach(doc => {
      preferencesDocs.push({ id: doc.id, data: doc.data() });
    });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö book_type document
    const bookTypeDoc = await db.collection('preferences').doc('book_type').get();
    const bookTypeData = bookTypeDoc.exists ? bookTypeDoc.data() : null;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö audio_content collection
    const audioSnapshot = await db.collection('audio_content').limit(5).get();
    const audioDocs = [];
    audioSnapshot.forEach(doc => {
      audioDocs.push({ id: doc.id, data: doc.data() });
    });
    
    res.json({
      status: 'OK',
      firestore_connection: 'success',
      project_id: process.env.FIREBASE_PROJECT_ID,
      features: {
        person_detection: 'enabled',
        fuzzy_search: 'enabled',
        smart_answering: 'enabled'
      },
      collections: {
        preferences: {
          size: preferencesSnapshot.size,
          sample_docs: preferencesDocs
        },
        book_type_document: bookTypeData,
        audio_content: {
          size: audioSnapshot.size,
          sample_docs: audioDocs
        }
      }
    });
  } catch (error) {
    res.status(500).json({
      status: 'ERROR',
      firestore_connection: 'failed',
      project_id: process.env.FIREBASE_PROJECT_ID,
      error: error.message
    });
  }
});

// ‡πÄ‡∏û‡∏¥‡πà‡∏° endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠
app.get('/test-detection/:question', (req, res) => {
  const question = decodeURIComponent(req.params.question);
  const person = detectPersonInQuestion(question);
  const cleaned = cleanQuestion(question);
  
  res.json({
    original_question: question,
    detected_person: person,
    cleaned_question: cleaned,
    search_term: cleaned || question
  });
});

const port = process.env.PORT || 3000;
app.listen(port, () => {
  console.log('üöÄ Server running on port', port);
  console.log('üìç Health check:', `http://localhost:${port}/health`);
  console.log('üîç Debug endpoint:', `http://localhost:${port}/debug`);
  console.log('üß™ Test detection:', `http://localhost:${port}/test-detection/[question]`);
});
